# ============================================================
# Cura3.ai — Frontend CI/CD Pipeline
# Build, test, and deploy the Next.js frontend to Azure
# ============================================================

name: Frontend CI/CD

on:
  push:
    branches: [main]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-ci-cd.yml'
  pull_request:
    branches: [main]
    paths:
      - 'frontend/**'

env:
  NODE_VERSION: '22'

jobs:

  # ── Lint & Build ──────────────────────────────────────────
  build:
    name: Lint & Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Lint
        working-directory: frontend
        run: npm run lint || echo "Lint warnings exist but build continues"

      - name: Build
        working-directory: frontend
        env:
          NEXT_PUBLIC_API_URL: "https://api.cura3.ai"
        run: npm run build

      - name: Verify build output
        working-directory: frontend
        run: |
          echo "✓ Checking build output..."
          if [ -d ".next" ]; then
            echo "  .next directory exists ✅"
            echo "  Build size: $(du -sh .next | cut -f1)"
          else
            echo "  ❌ Build failed — .next directory not found"
            exit 1
          fi

      - name: Upload build artifact
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: actions/upload-artifact@v4
        with:
          name: frontend-build
          path: |
            frontend/.next
            frontend/public
            frontend/package.json
            frontend/package-lock.json
            frontend/next.config.ts
          retention-days: 3

  # ── Build Docker Image ──────────────────────────────────
  docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        working-directory: frontend
        run: |
          docker build \
            --build-arg NEXT_PUBLIC_API_URL="https://api.cura3.ai" \
            -t cura3-frontend:${{ github.sha }} .

      - name: Verify image runs
        run: |
          docker run -d --name cura3-fe-test -p 3000:3000 cura3-frontend:${{ github.sha }}
          sleep 8
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "http://localhost:3000" || echo "000")
          echo "Frontend responded with HTTP $HTTP_STATUS"
          docker stop cura3-fe-test

  # ── Deploy to Azure ────────────────────────────────────
  deploy:
    name: Deploy to Azure
    runs-on: ubuntu-latest
    needs: docker
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Azure
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Static Web Apps
        uses: azure/static-web-apps-deploy@v1
        with:
          azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_TOKEN }}
          action: upload
          app_location: /frontend
          output_location: .next

      - name: Smoke test deployment
        run: |
          echo "Waiting for deployment to stabilize..."
          sleep 30
          SITE_URL="${{ secrets.AZURE_FRONTEND_URL || 'https://cura3.ai' }}"
          echo "Checking: $SITE_URL"
          HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" "$SITE_URL" || echo "000")
          if [ "$HTTP_STATUS" = "200" ]; then
            echo "✅ Frontend is live (HTTP $HTTP_STATUS)"
          else
            echo "⚠️ Frontend returned HTTP $HTTP_STATUS (may still be deploying)"
          fi
